- resources = plan_resources(plan)

%div.row

  %div.col.system-settings

    = plan_section_header 'System settings', 'settings'
    %dl.row
      %dt.col-4 System identifier:
      %dd.col-8= plan.dig('variables', 'system_identifier', 'value').upcase
      %dt.col-4 Instance number:
      %dd.col-8= plan.dig('variables', 'instance_number', 'value')
      %dt.col-4 Admin user:
      %dd.col-8= plan.dig('variables', 'system_identifier', 'value').downcase.concat('adm')
      %dt.col-4 Admin password:
      %dd.col-8.mb-0
        %div#admin-password
          %span.peek{ style: "display: none;" }= plan.dig('variables', 'sap_admin_password', 'value')
          %span.unpeek ●●●●●●●●●●
          %div.plan-icon-append.peek{ data: { toggle: 'tooltip' }, title: t(:password_hide), style: "display: none;" }
            %i.eos-icons.eos-24 visibility
          %div.plan-icon-append.unpeek{ data: { toggle: 'tooltip' }, title: t(:password_show) }
            %i.eos-icons.eos-24 visibility_off

  %div.col.resource-group

    = plan_section_header 'Resource group', 'namespace'
    %dl.row
      %dt.col-4 Name:
      %dd.col-8= resources.dig('module.bluehorizon.azurerm_resource_group.myrg[0]', 'values', 'name')
      %dt.col-4 Region:
      %dd.col-8= resources.dig('module.bluehorizon.azurerm_resource_group.myrg[0]', 'values', 'location')

%div.row

  %div.col-6.virtual-networks

    = plan_section_header 'Virtual networks', 'ip'
    %dl.row.network
      %dt.col-4 Name:
      %dd.col-8= resources.dig 'module.bluehorizon.azurerm_virtual_network.mynet[0]', 'values', 'name'
      %dt.col-4 Address range:
      %dd.col-8= resources.dig('module.bluehorizon.azurerm_virtual_network.mynet[0]', 'values', 'address_space').join(',')
    %dl.row.network
      %dt.col-4 Name:
      %dd.col-8= resources.dig 'module.bluehorizon.azurerm_subnet.mysubnet[0]', 'values', 'name'
      %dt.col-4 Address range:
      %dd.col-8= resources.dig('module.bluehorizon.azurerm_subnet.mysubnet[0]', 'values', 'address_prefixes').join(',')

  - if plan.dig('variables', 'hana_ha_enabled', 'value') == true
    %div.col-6.iscsi-server

      = plan_section_header 'ISCSI server', 'storage'
      %dl.row
        %dt.col-4 Name:
        %dd.col-8= resources.dig 'module.bluehorizon.module.iscsi_server.azurerm_virtual_machine.iscsisrv[0]','values', 'name'
        %dt.col-4 Size:
        %dd.col-8= resources.dig 'module.bluehorizon.module.iscsi_server.azurerm_virtual_machine.iscsisrv[0]', 'values', 'vm_size'
        %dt.col-4 Private IP address:
        %dd.col-8= resources.dig 'module.bluehorizon.module.iscsi_server.azurerm_network_interface.iscsisrv[0]', 'values', 'ip_configuration', 0, 'private_ip_address'
        %dt.col-4 OS Image:
        %dd.col-8= resources.dig 'module.bluehorizon.module.iscsi_server.azurerm_virtual_machine.iscsisrv[0]', 'values', 'storage_image_reference', 0, 'offer'
        %dt.col-4 Data disks:
        %dd.col-8.mb-0
          - (resources.dig('module.bluehorizon.module.iscsi_server.azurerm_virtual_machine.iscsisrv[0]', 'values', 'storage_data_disk')||[]).each do |disk|
            %li.py-0.disk
              %span= disk['name']
              %span= "(#{disk['disk_size_gb']}GB)"

%div.row

  %div.col.hana-nodes

    = plan_section_header 'HANA nodes', 'node'
    %div.row
      - node_pattern = /module\.bluehorizon\.module\.hana_node\.azurerm_virtual_machine\.hana/
      - resources.select { |address| address =~ node_pattern }.each_with_index do |(address, vm_resource),index|
        %div.col-6.hana-node
          %dl.row{id: address}
            %dt.col-4 Name:
            %dd.col-8= vm_resource.dig 'values', 'name'
            %dt.col-4 Size:
            %dd.col-8= vm_resource.dig 'values', 'vm_size'
            %dt.col-4 Private IP address:
            %dd.col-8= resources.dig "module.bluehorizon.module.hana_node.azurerm_network_interface.hana[#{index}]", 'values', 'ip_configuration', 0, 'private_ip_address'
            %dt.col-4 OS Image:
            %dd.col-8= vm_resource.dig 'values', 'storage_image_reference', 0, 'offer'
            %dt.col-4 Data disks:
            %dd.col-8.mb-0
              - (vm_resource.dig('values', 'storage_data_disk')||[]).each do |disk|
                %li.py-0.disk
                  %span= disk['name']
                  %span= "(#{disk['disk_size_gb']}GB)"

%div.row

  %div.col.bastion

    = plan_section_header 'Bastion', 'security'
    %dl.row
      %dt.col-4 Name:
      %dd.col-8= resources.dig 'module.bluehorizon.module.bastion.azurerm_virtual_machine.bastion[0]', 'values', 'name'
      %dt.col-4 Size:
      %dd.col-8= resources.dig 'module.bluehorizon.module.bastion.azurerm_virtual_machine.bastion[0]', 'values', 'vm_size'
      %dt.col-4 Private IP address:
      %dd.col-8= resources.dig 'module.bluehorizon.module.bastion.azurerm_network_interface.bastion[0]', 'values', 'ip_configuration', 0, 'private_ip_address'
      %dt.col-4 OS Image:
      %dd.col-8= resources.dig 'module.bluehorizon.module.bastion.azurerm_virtual_machine.bastion[0]', 'values', 'storage_image_reference', 0, 'offer'

  %div.col.monitoring-server

    = plan_section_header 'Monitoring server', 'monitoring'
    %dl.row
      %dt.col-4 Name:
      %dd.col-8= resources.dig 'module.bluehorizon.module.monitoring.azurerm_virtual_machine.monitoring[0]','values', 'name'
      %dt.col-4 Size:
      %dd.col-8= resources.dig 'module.bluehorizon.module.monitoring.azurerm_virtual_machine.monitoring[0]', 'values', 'vm_size'
      %dt.col-4 Private IP address:
      %dd.col-8= resources.dig 'module.bluehorizon.module.monitoring.azurerm_network_interface.monitoring[0]', 'values', 'ip_configuration', 0, 'private_ip_address'
      %dt.col-4 OS Image:
      %dd.col-8= resources.dig 'module.bluehorizon.module.monitoring.azurerm_virtual_machine.monitoring[0]', 'values', 'storage_image_reference', 0, 'offer'
      %dt.col-4 Data disks:
      %dd.col-8.mb-0
        - (resources.dig('module.bluehorizon.module.monitoring.azurerm_virtual_machine.monitoring[0]', 'values', 'storage_data_disk')||[]).each do |disk|
          %li.py-0.disk
            %span= disk['name']
            %span= "(#{disk['disk_size_gb']}GB)"

%div.row

  %div.col.security-group

    = plan_section_header 'Security group', 'network_policy'
    %dl.row
      %dt.col-2 Name:
      %dd.col-10= resources.dig 'module.bluehorizon.azurerm_network_security_group.mysecgroup', 'values', 'name'
      %dt.col-12 Rules:
      %dd.col-12
        %table.table.rules
          %thead
            %th Name
            %th Access
            %th Direction
            %th Source addresses
            %th Source ports
            %th Destination addresses
            %th Destination ports
            %th Protocol
          %tbody
            - (resources.dig('module.bluehorizon.azurerm_network_security_group.mysecgroup', 'values', 'security_rule')||[]).each do |rule|
              %tr.rule
                %td= rule['name']
                %td= rule['access']
                %td= rule['direction']
                %td= "#{rule['source_address_prefix']} #{rule['source_address_prefixes'].join(',')}"
                %td= "#{rule['source_port_range']} #{rule['source_port_ranges'].join(',')}"
                %td= "#{rule['destination_address_prefix']} #{rule['destination_address_prefixes'].join(',')}"
                %td= "#{rule['destination_port_range']} #{rule['destination_port_ranges'].join(',')}"
                %td= rule['protocol']
